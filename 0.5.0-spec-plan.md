# Unify 0.5.0 Implementation Plan - Convention-Based Architecture

## Overview

This document outlines the implementation plan for migrating Unify from explicit CLI configuration (`--layouts`, `--components`) to a convention-based approach using underscore-prefixed files and directories.

## Breaking Changes Summary

### Removed CLI Options
- `--layouts, -l` flag removed
- `--components, -c` flag removed

### New Convention-Based System
- Files/folders starting with `_` are non-emitting by convention
- Layout files: any file starting with `_` and ending with `layout.html` or `layout.htm`
- `src/_includes/` for shared partials/layouts  
- `src/_includes/_layout.html` as optional fallback layout
- Layout discovery climbs from page folder to `src/` root

## Implementation Steps

### Phase 1: CLI Argument Parser Updates

#### 1.1 Remove Deprecated Options
**File**: `src/cli/args-parser.js`
- Remove `--layouts, -l` option handling
- Remove `--components, -c` option handling 
- Remove `layouts` and `components` from default args object
- Update help text and error suggestions

#### 1.2 Update CLI Help Text
**File**: `bin/cli.js`
- Remove `--layouts` and `--components` from help display
- Ensure `--assets, -a` option is properly documented

#### 1.3 Update Argument Parser Tests
**Files**: `test/unit/args-parser*.test.js`
- Remove tests for deprecated `--layouts` and `--components` options
- Add tests to ensure deprecated options are rejected with helpful error messages
- Update help text validation tests

### Phase 2: Core File Classification System

#### 2.1 File Classification Logic
**New File**: `src/core/file-classifier.js`
Create new module to classify files based on conventions:

```javascript
export class FileClassifier {
  // Determine if file is a page (emitting)
  isPage(filePath, sourceRoot) {
    // .html/.md files not starting with _ = pages
  }
  
  // Determine if file is a partial (non-emitting)  
  isPartial(filePath, sourceRoot) {
    // .html/.md files starting with _ = partials
  }
  
  // Determine if file is a layout
  isLayout(filePath, sourceRoot) {
    // Files starting with _ and ending with layout.html/.htm = layouts
  }
  
  // Check if file should be emitted to output
  shouldEmit(filePath, sourceRoot) {
    // Pages and referenced assets only
  }
}
```

#### 2.2 Layout Discovery System
**New File**: `src/core/layout-discovery.js`
Implement convention-based layout discovery:

```javascript
export class LayoutDiscovery {
  // Find layout for a given page
  findLayoutForPage(pagePath, sourceRoot) {
    // 1. Look for layout files matching _*.layout.html in page's directory
    // 2. Climb up to source root, checking each directory
    // 3. Check for src/_includes/_layout.html fallback
    // 4. Return null if no layout found
  }
  
  // Get all layouts that apply to a page (nested)
  getLayoutChain(pagePath, sourceRoot) {
    // Build array of layouts from most specific to least specific
  }
}
```

#### 2.3 Include Resolution Updates
**File**: `src/core/include-processor.js`
Update include resolution to work with new conventions:

- Remove dependency on explicit components directory
- Update path resolution to check `_includes/` directory
- Maintain existing Apache SSI and DOM include syntax
- Add validation for underscore conventions

### Phase 3: File Processing Pipeline Updates

#### 3.1 Build Process Updates
**File**: `src/core/file-processor.js`
- Integrate `FileClassifier` to determine file types
- Use `LayoutDiscovery` instead of explicit layout directory
- Update file scanning to respect underscore conventions
- Ensure non-emitting files are not copied to output

#### 3.2 Dependency Tracking Updates  
**File**: `src/core/dependency-tracker.js`
- Track dependencies for underscore files (_layout.html, _includes/, etc.)
- Update change detection for new layout discovery
- Ensure dependent pages rebuild when layouts change

#### 3.3 Asset Processing Updates
**File**: `src/core/asset-tracker.js`
- Respect underscore conventions for asset files
- Only copy underscore-prefixed assets if explicitly referenced
- Update asset scanning to work with new file structure

### Phase 4: Error Handling & Validation

#### 4.1 Migration Error Messages
Add helpful error messages for common migration scenarios:
- Warn if `.layouts/` or `.components/` directories exist
- Suggest migration steps for existing projects
- Provide clear guidance on new conventions

#### 4.2 Layout Override Validation
**File**: `src/core/unified-html-processor.js` 
- Handle missing override layouts gracefully
- Fall back to nearest available layout
- Warn if non-underscore files are only used as includes

#### 4.3 Convention Validation
Add validation for proper convention usage:
- Warn if underscore files would be accessible as pages
- Validate layout file structure
- Check for circular layout dependencies

### Phase 5: Testing & Validation

#### 5.1 Unit Tests
Create comprehensive unit tests for new modules:
- `test/unit/file-classifier.test.js`
- `test/unit/layout-discovery.test.js`
- Update existing unit tests for modified modules

#### 5.2 Integration Tests
- `test/integration/convention-based-layouts.test.js`
- `test/integration/underscore-conventions.test.js`
- `test/integration/migration-scenarios.test.js`

#### 5.3 Example Project Updates
Update example projects to use new conventions:
- Migrate `example/src/` structure
- Migrate `example/advanced/src/` structure
- Update documentation and README examples

### Phase 6: Documentation & Migration Guide

#### 6.1 Migration Documentation
**New File**: `docs/migration-to-0.5.0.md`
- Step-by-step migration guide
- Before/after directory structure examples
- Common migration scenarios and solutions
- Breaking change compatibility notes

#### 6.2 Updated Documentation
- Update `docs/getting-started.md` with new conventions
- Update `docs/layouts-slots-templates.md` for new layout discovery
- Update `docs/cli-reference.md` to remove deprecated options

## Implementation Order

### Priority 1 (Core Functionality)
1. CLI argument parser updates (Phase 1)
2. File classification system (Phase 2.1)
3. Layout discovery system (Phase 2.2)
4. Build process updates (Phase 3.1)

### Priority 2 (Integration)  
5. Include resolution updates (Phase 2.3)
6. Dependency tracking updates (Phase 3.2)
7. Error handling updates (Phase 4)

### Priority 3 (Testing & Documentation)
8. Unit and integration tests (Phase 5)
9. Example project updates (Phase 5.3)
10. Documentation updates (Phase 6)

## Testing Strategy

### Backward Compatibility Testing
- Test that existing functionality still works
- Ensure error messages are helpful for deprecated usage
- Verify migration path works for existing projects

### Convention Testing
- Test all underscore convention behaviors
- Verify layout discovery in various directory structures  
- Test edge cases and error conditions

### Performance Testing
- Ensure new convention-based discovery doesn't impact performance
- Verify incremental builds still work efficiently
- Test memory usage with new file classification

## Risk Mitigation

### Breaking Change Communication
- Clear version bump to 0.5.0 indicates breaking changes
- Comprehensive migration documentation
- Helpful error messages for deprecated usage

### Fallback Behavior
- Graceful degradation when conventions aren't followed
- Clear error messages with suggestions
- Maintain existing include syntax compatibility

### Testing Coverage
- Comprehensive test suite for new functionality
- Integration tests covering real-world scenarios
- Performance regression testing

## Success Criteria

### Functional Requirements
- [ ] All existing functionality works with new conventions
- [ ] Layout discovery works correctly in all scenarios
- [ ] File classification respects underscore conventions
- [ ] Include resolution works with new directory structure
- [ ] Error messages are helpful and actionable

### Performance Requirements  
- [ ] Build performance maintained or improved
- [ ] Memory usage remains within acceptable limits
- [ ] File watching and live reload continue to work efficiently

### Usability Requirements
- [ ] Migration from 0.4.x to 0.5.0 is straightforward
- [ ] New convention-based approach is intuitive
- [ ] Documentation clearly explains new system
- [ ] Error messages guide users toward correct usage

## Migration Notes

### For Existing Users
Existing projects using `--layouts` and `--components` flags will need to:

1. Move layout files to appropriate `_layout.html` files in folders
2. Move shared components to `src/_includes/` directory  
3. Rename files to use underscore conventions
4. Remove CLI flags from build scripts
5. Update any documentation or tooling

### For New Users
New users benefit from:
- Zero configuration required
- Intuitive file organization
- Convention over configuration approach
- Clearer separation of concerns